import{a as x}from"./chunk-YJ67FVZQ.js";import"./chunk-S6MXMXK4.js";import"./chunk-T2NSUFSZ.js";import{b as k}from"./chunk-32IAVZSY.js";import{a as b}from"./chunk-MFSGMIY7.js";import"./chunk-ACEJN2MV.js";import"./chunk-EEENIMDP.js";import{k as s,l as d}from"./chunk-XQMGIZNC.js";import{A as z,B as p,a as y,b as m,f as n,t as u,v as c}from"./chunk-DKJ7BJEZ.js";import{e as h,f as i}from"./chunk-EQVTEUXC.js";var v=h(c(),1);var C=h(c(),1);var A=h(c(),1);var N=(0,A.default)("music-metadata:parser:musepack:sv8"),O=new u(2,"latin1"),B={len:5,get:(a,e)=>({crc:n.get(a,e),streamVersion:y.get(a,e+4)})},P={len:2,get:(a,e)=>({sampleFrequency:[44100,48e3,37800,32e3][s(a,e,0,3)],maxUsedBands:s(a,e,3,5),channelCount:s(a,e+1,0,4)+1,msUsed:d(a,e+1,4),audioBlockFrames:s(a,e+1,5,3)})},g=class{get tokenizer(){return this._tokenizer}set tokenizer(e){this._tokenizer=e}constructor(e){this._tokenizer=e}readPacketHeader(){return i(this,null,function*(){let e=yield this.tokenizer.readToken(O),t=yield this.readVariableSizeField();return{key:e,payloadLength:t.value-2-t.len}})}readStreamHeader(e){return i(this,null,function*(){let t={};N(`Reading SH at offset=${this.tokenizer.position}`);let r=yield this.tokenizer.readToken(B);e-=B.len,Object.assign(t,r),N(`SH.streamVersion = ${r.streamVersion}`);let l=yield this.readVariableSizeField();e-=l.len,t.sampleCount=l.value;let L=yield this.readVariableSizeField();e-=L.len,t.beginningOfSilence=L.value;let H=yield this.tokenizer.readToken(P);return e-=P.len,Object.assign(t,H),yield this.tokenizer.ignore(e),t})}readVariableSizeField(e=1,t=0){return i(this,null,function*(){let r=yield this.tokenizer.readNumber(y);return(r&128)===0?{len:e,value:t+r}:(r&=127,r+=t,this.readVariableSizeField(e+1,r<<7))})}};var o=class extends z("Musepack"){};var $=(0,C.default)("music-metadata:parser:musepack"),w=class extends p{constructor(){super(...arguments),this.audioLength=0}parse(){return i(this,null,function*(){if((yield this.tokenizer.readToken(b))!=="MPCK")throw new o("Invalid Magic number");return this.metadata.setFormat("container","Musepack, SV8"),this.parsePacket()})}parsePacket(){return i(this,null,function*(){let e=new g(this.tokenizer);do{let t=yield e.readPacketHeader();switch($(`packet-header key=${t.key}, payloadLength=${t.payloadLength}`),t.key){case"SH":{let r=yield e.readStreamHeader(t.payloadLength);this.metadata.setFormat("numberOfSamples",r.sampleCount),this.metadata.setFormat("sampleRate",r.sampleFrequency),this.metadata.setFormat("duration",r.sampleCount/r.sampleFrequency),this.metadata.setFormat("numberOfChannels",r.channelCount);break}case"AP":this.audioLength+=t.payloadLength,yield this.tokenizer.ignore(t.payloadLength);break;case"RG":case"EI":case"SO":case"ST":case"CT":yield this.tokenizer.ignore(t.payloadLength);break;case"SE":return this.metadata.format.duration&&this.metadata.setFormat("bitrate",this.audioLength*8/this.metadata.format.duration),k(this.metadata,this.tokenizer,this.options);default:throw new o(`Unexpected header: ${t.key}`)}}while(!0)})}};var U=h(c(),1);var T=class{constructor(e){this.pos=0,this.dword=null,this.tokenizer=e}read(e){return i(this,null,function*(){for(;this.dword===null;)this.dword=yield this.tokenizer.readToken(n);let t=this.dword;return this.pos+=e,this.pos<32?(t>>>=32-this.pos,t&(1<<e)-1):(this.pos-=32,this.pos===0?(this.dword=null,t&(1<<e)-1):(this.dword=yield this.tokenizer.readToken(n),this.pos&&(t<<=this.pos,t|=this.dword>>>32-this.pos),t&(1<<e)-1))})}ignore(e){return i(this,null,function*(){if(this.pos>0){let l=32-this.pos;this.dword=null,e-=l,this.pos=0}let t=e%32,r=(e-t)/32;return yield this.tokenizer.ignore(r*4),this.read(t)})}};var E={len:6*4,get:(a,e)=>{let t={signature:new TextDecoder("latin1").decode(a.subarray(e,e+3)),streamMinorVersion:s(a,e+3,0,4),streamMajorVersion:s(a,e+3,4,4),frameCount:n.get(a,e+4),maxLevel:m.get(a,e+8),sampleFrequency:[44100,48e3,37800,32e3][s(a,e+10,0,2)],link:s(a,e+10,2,2),profile:s(a,e+10,4,4),maxBand:s(a,e+11,0,6),intensityStereo:d(a,e+11,6),midSideStereo:d(a,e+11,7),titlePeak:m.get(a,e+12),titleGain:m.get(a,e+14),albumPeak:m.get(a,e+16),albumGain:m.get(a,e+18),lastFrameLength:n.get(a,e+20)>>>20&2047,trueGapless:d(a,e+23,0)};return t.lastFrameLength=t.trueGapless?n.get(a,20)>>>20&2047:0,t}};var I=(0,U.default)("music-metadata:parser:musepack"),S=class extends p{constructor(){super(...arguments),this.bitreader=null,this.audioLength=0,this.duration=null}parse(){return i(this,null,function*(){let e=yield this.tokenizer.readToken(E);if(e.signature!=="MP+")throw new o("Unexpected magic number");I(`stream-version=${e.streamMajorVersion}.${e.streamMinorVersion}`),this.metadata.setFormat("container","Musepack, SV7"),this.metadata.setFormat("sampleRate",e.sampleFrequency);let t=1152*(e.frameCount-1)+e.lastFrameLength;this.metadata.setFormat("numberOfSamples",t),this.duration=t/e.sampleFrequency,this.metadata.setFormat("duration",this.duration),this.bitreader=new T(this.tokenizer),this.metadata.setFormat("numberOfChannels",e.midSideStereo||e.intensityStereo?2:1);let r=yield this.bitreader.read(8);return this.metadata.setFormat("codec",(r/100).toFixed(2)),yield this.skipAudioData(e.frameCount),I(`End of audio stream, switching to APEv2, offset=${this.tokenizer.position}`),k(this.metadata,this.tokenizer,this.options)})}skipAudioData(e){return i(this,null,function*(){for(;e-- >0;){let r=yield this.bitreader.read(20);this.audioLength+=20+r,yield this.bitreader.ignore(r)}let t=yield this.bitreader.read(11);this.audioLength+=t,this.duration!==null&&this.metadata.setFormat("bitrate",this.audioLength/this.duration)})}};var V=(0,v.default)("music-metadata:parser:musepack"),_=class extends x{postId3v2Parse(){return i(this,null,function*(){let e=yield this.tokenizer.peekToken(new u(3,"latin1")),t;switch(e){case"MP+":{V("Stream-version 7"),t=new S(this.metadata,this.tokenizer,this.options);break}case"MPC":{V("Stream-version 8"),t=new w(this.metadata,this.tokenizer,this.options);break}default:throw new o("Invalid signature prefix")}return this.metadata.setAudioOnly(),t.parse()})}};export{_ as MusepackParser};
