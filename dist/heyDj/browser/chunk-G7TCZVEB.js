import{a as x}from"./chunk-S6MXMXK4.js";import"./chunk-T2NSUFSZ.js";import"./chunk-32IAVZSY.js";import{a as I}from"./chunk-MFSGMIY7.js";import{a as F,c as w}from"./chunk-ACEJN2MV.js";import"./chunk-EEENIMDP.js";import{j as c}from"./chunk-XQMGIZNC.js";import{A as z,B as E,b as r,f as h,s as l,t as o,v as L}from"./chunk-DKJ7BJEZ.js";import{e as C,f as d}from"./chunk-EQVTEUXC.js";var R=C(L(),1);var T={len:8,get:(n,e)=>({chunkID:new o(4,"latin1").get(n,e),chunkSize:h.get(n,e+4)})},p=class{constructor(e){this.tagHeader=e,this.len=e.chunkSize,this.len+=this.len&1}get(e,t){return new o(this.tagHeader.chunkSize,"ascii").get(e,t)}};var m=class extends z("Wave"){},s={PCM:1,ADPCM:2,IEEE_FLOAT:3,MPEG_ADTS_AAC:5632,MPEG_LOAS:5634,RAW_AAC1:255,DOLBY_AC3_SPDIF:146,DVM:8192,RAW_SPORT:576,ESST_AC3:577,DRM:9,DTS2:8193,MPEG:80},_={[s.PCM]:"PCM",[s.ADPCM]:"ADPCM",[s.IEEE_FLOAT]:"IEEE_FLOAT",[s.MPEG_ADTS_AAC]:"MPEG_ADTS_AAC",[s.MPEG_LOAS]:"MPEG_LOAS",[s.RAW_AAC1]:"RAW_AAC1",[s.DOLBY_AC3_SPDIF]:"DOLBY_AC3_SPDIF",[s.DVM]:"DVM",[s.RAW_SPORT]:"RAW_SPORT",[s.ESST_AC3]:"ESST_AC3",[s.DRM]:"DRM",[s.DTS2]:"DTS2",[s.MPEG]:"MPEG"},u=class{constructor(e){if(e.chunkSize<16)throw new m("Invalid chunk size");this.len=e.chunkSize}get(e,t){return{wFormatTag:r.get(e,t),nChannels:r.get(e,t+2),nSamplesPerSec:h.get(e,t+4),nAvgBytesPerSec:h.get(e,t+8),nBlockAlign:r.get(e,t+12),wBitsPerSample:r.get(e,t+14)}}},S=class{constructor(e){if(e.chunkSize<4)throw new m("Invalid fact chunk size.");this.len=e.chunkSize}get(e,t){return{dwSampleLength:h.get(e,t)}}};var A={len:420,get:(n,e)=>({description:c(new o(256,"ascii").get(n,e)).trim(),originator:c(new o(32,"ascii").get(n,e+256)).trim(),originatorReference:c(new o(32,"ascii").get(n,e+288)).trim(),originationDate:c(new o(10,"ascii").get(n,e+320)).trim(),originationTime:c(new o(8,"ascii").get(n,e+330)).trim(),timeReferenceLow:h.get(n,e+338),timeReferenceHigh:h.get(n,e+342),version:r.get(n,e+346),umid:new l(64).get(n,e+348),loudnessValue:r.get(n,e+412),maxTruePeakLevel:r.get(n,e+414),maxMomentaryLoudness:r.get(n,e+416),maxShortTermLoudness:r.get(n,e+418)})};var k=(0,R.default)("music-metadata:parser:RIFF"),D=class extends E{constructor(){super(...arguments),this.blockAlign=0}parse(){return d(this,null,function*(){let e=yield this.tokenizer.readToken(T);if(k(`pos=${this.tokenizer.position}, parse: chunkID=${e.chunkID}`),e.chunkID==="RIFF")return this.metadata.setAudioOnly(),this.parseRiffChunk(e.chunkSize).catch(t=>{if(!(t instanceof F))throw t})})}parseRiffChunk(e){return d(this,null,function*(){let t=yield this.tokenizer.readToken(I);switch(this.metadata.setFormat("container",t),t){case"WAVE":return this.readWaveChunk(e-I.len);default:throw new m(`Unsupported RIFF format: RIFF/${t}`)}})}readWaveChunk(e){return d(this,null,function*(){for(;e>=T.len;){let t=yield this.tokenizer.readToken(T);switch(e-=T.len+t.chunkSize,t.chunkSize>e&&this.metadata.addWarning("Data chunk size exceeds file size"),this.header=t,k(`pos=${this.tokenizer.position}, readChunk: chunkID=RIFF/WAVE/${t.chunkID}`),t.chunkID){case"LIST":yield this.parseListTag(t);break;case"fact":this.metadata.setFormat("lossless",!1),this.fact=yield this.tokenizer.readToken(new S(t));break;case"fmt ":{let a=yield this.tokenizer.readToken(new u(t)),i=_[a.wFormatTag];i||(k(`WAVE/non-PCM format=${a.wFormatTag}`),i=`non-PCM (${a.wFormatTag})`),this.metadata.setFormat("codec",i),this.metadata.setFormat("bitsPerSample",a.wBitsPerSample),this.metadata.setFormat("sampleRate",a.nSamplesPerSec),this.metadata.setFormat("numberOfChannels",a.nChannels),this.metadata.setFormat("bitrate",a.nBlockAlign*a.nSamplesPerSec*8),this.blockAlign=a.nBlockAlign;break}case"id3 ":case"ID3 ":{let a=yield this.tokenizer.readToken(new l(t.chunkSize)),i=w(a);yield new x().parse(this.metadata,i,this.options);break}case"data":{this.metadata.format.lossless!==!1&&this.metadata.setFormat("lossless",!0);let a=t.chunkSize;if(this.tokenizer.fileInfo.size){let g=this.tokenizer.fileInfo.size-this.tokenizer.position;g<a&&(this.metadata.addWarning("data chunk length exceeding file length"),a=g)}let i=this.fact?this.fact.dwSampleLength:a===4294967295?void 0:a/this.blockAlign;i&&(this.metadata.setFormat("numberOfSamples",i),this.metadata.format.sampleRate&&this.metadata.setFormat("duration",i/this.metadata.format.sampleRate)),this.metadata.format.codec==="ADPCM"?this.metadata.setFormat("bitrate",352e3):this.metadata.format.sampleRate&&this.metadata.setFormat("bitrate",this.blockAlign*this.metadata.format.sampleRate*8),yield this.tokenizer.ignore(t.chunkSize);break}case"bext":{let a=yield this.tokenizer.readToken(A);Object.keys(a).forEach(g=>{this.metadata.addTag("exif",`bext.${g}`,a[g])});let i=t.chunkSize-A.len;yield this.tokenizer.ignore(i);break}case"\0\0\0\0":k(`Ignore padding chunk: RIFF/${t.chunkID} of ${t.chunkSize} bytes`),this.metadata.addWarning(`Ignore chunk: RIFF/${t.chunkID}`),yield this.tokenizer.ignore(t.chunkSize);break;default:k(`Ignore chunk: RIFF/${t.chunkID} of ${t.chunkSize} bytes`),this.metadata.addWarning(`Ignore chunk: RIFF/${t.chunkID}`),yield this.tokenizer.ignore(t.chunkSize)}this.header.chunkSize%2===1&&(k("Read odd padding byte"),yield this.tokenizer.ignore(1))}})}parseListTag(e){return d(this,null,function*(){let t=yield this.tokenizer.readToken(new o(4,"latin1"));switch(k("pos=%s, parseListTag: chunkID=RIFF/WAVE/LIST/%s",this.tokenizer.position,t),t){case"INFO":return this.parseRiffInfoTags(e.chunkSize-4);default:return this.metadata.addWarning(`Ignore chunk: RIFF/WAVE/LIST/${t}`),k(`Ignoring chunkID=RIFF/WAVE/LIST/${t}`),this.tokenizer.ignore(e.chunkSize-4).then()}})}parseRiffInfoTags(e){return d(this,null,function*(){for(;e>=8;){let t=yield this.tokenizer.readToken(T),a=new p(t),i=yield this.tokenizer.readToken(a);this.addTag(t.chunkID,c(i)),e-=8+a.len}if(e!==0)throw new m(`Illegal remaining size: ${e}`)})}addTag(e,t){this.metadata.addTag("exif",e,t)}};export{D as WaveParser};
