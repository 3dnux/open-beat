import{a as A,b as C,c as I}from"./chunk-OK7QL45V.js";import{a as T}from"./chunk-YJ67FVZQ.js";import"./chunk-S6MXMXK4.js";import"./chunk-T2NSUFSZ.js";import"./chunk-32IAVZSY.js";import{a as u}from"./chunk-MFSGMIY7.js";import"./chunk-ACEJN2MV.js";import"./chunk-EEENIMDP.js";import{f as k,k as m}from"./chunk-XQMGIZNC.js";import{A as g,c as h,e as o,s as c,v as P}from"./chunk-DKJ7BJEZ.js";import{e as w,f as s}from"./chunk-EQVTEUXC.js";var E=w(P(),1);var y=(0,E.default)("music-metadata:parser:FLAC"),l=class extends g("FLAC"){},i={STREAMINFO:0,PADDING:1,APPLICATION:2,SEEKTABLE:3,VORBIS_COMMENT:4,CUESHEET:5,PICTURE:6},S=class extends T{constructor(){super(...arguments),this.vorbisParser=new I(this.metadata,this.options),this.padding=0}postId3v2Parse(){return s(this,null,function*(){if((yield this.tokenizer.readToken(u)).toString()!=="fLaC")throw new l("Invalid FLAC preamble");this.metadata.setAudioOnly();let a;do a=yield this.tokenizer.readToken(z),yield this.parseDataBlock(a);while(!a.lastBlock);if(this.tokenizer.fileInfo.size&&this.metadata.format.duration){let n=this.tokenizer.fileInfo.size-this.tokenizer.position;this.metadata.setFormat("bitrate",8*n/this.metadata.format.duration)}})}parseDataBlock(t){return s(this,null,function*(){switch(y(`blockHeader type=${t.type}, length=${t.length}`),t.type){case i.STREAMINFO:return this.parseBlockStreamInfo(t.length);case i.PADDING:this.padding+=t.length;break;case i.APPLICATION:break;case i.SEEKTABLE:break;case i.VORBIS_COMMENT:return this.parseComment(t.length);case i.CUESHEET:break;case i.PICTURE:yield this.parsePicture(t.length);return;default:this.metadata.addWarning(`Unknown block type: ${t.type}`)}return this.tokenizer.ignore(t.length).then()})}parseBlockStreamInfo(t){return s(this,null,function*(){if(t!==B.len)throw new l("Unexpected block-stream-info length");let a=yield this.tokenizer.readToken(B);this.metadata.setFormat("container","FLAC"),this.metadata.setFormat("codec","FLAC"),this.metadata.setFormat("lossless",!0),this.metadata.setFormat("numberOfChannels",a.channels),this.metadata.setFormat("bitsPerSample",a.bitsPerSample),this.metadata.setFormat("sampleRate",a.sampleRate),a.totalSamples>0&&this.metadata.setFormat("duration",a.totalSamples/a.sampleRate)})}parseComment(t){return s(this,null,function*(){let a=yield this.tokenizer.readToken(new c(t)),n=new C(a,0);n.readStringUtf8();let p=n.readInt32(),d=new Array(p);for(let r=0;r<p;r++)d[r]=n.parseUserComment();yield Promise.all(d.map(r=>this.vorbisParser.addTag(r.key,r.value)))})}parsePicture(t){return s(this,null,function*(){if(this.options.skipCovers)return this.tokenizer.ignore(t);let a=yield this.tokenizer.readToken(new A(t));this.vorbisParser.addTag("METADATA_BLOCK_PICTURE",a)})}},z={len:4,get:(e,t)=>({lastBlock:k(e,t,7),type:m(e,t,1,7),length:o.get(e,t+1)})},B={len:34,get:(e,t)=>({minimumBlockSize:h.get(e,t),maximumBlockSize:h.get(e,t+2)/1e3,minimumFrameSize:o.get(e,t+4),maximumFrameSize:o.get(e,t+7),sampleRate:o.get(e,t+10)>>4,channels:m(e,t+12,4,3)+1,bitsPerSample:m(e,t+12,7,5)+1,totalSamples:m(e,t+13,4,36),fileMD5:new c(16).get(e,t+18)})};export{S as FlacParser};
