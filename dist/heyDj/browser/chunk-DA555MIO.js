import"./chunk-KZAVUP2Y.js";import{b as ne}from"./chunk-LGB3GLMH.js";import{a as oe}from"./chunk-T2NSUFSZ.js";import"./chunk-32IAVZSY.js";import{a as Y}from"./chunk-MFSGMIY7.js";import"./chunk-ACEJN2MV.js";import"./chunk-EEENIMDP.js";import{a as te,c as ae,f as T}from"./chunk-XQMGIZNC.js";import{A as se,B as re,a as p,c as g,e as u,g as i,h as y,i as B,j as q,k,o as Q,s as U,t as I,u as J,v as X}from"./chunk-DKJ7BJEZ.js";import{e as G,f as d}from"./chunk-EQVTEUXC.js";var Ie=G(X(),1);var pe=G(X(),1);var le=G(X(),1);var b=(0,le.default)("music-metadata:parser:MP4:atom"),w=class extends se("MP4"){},N={len:8,get:(r,e)=>{let t=i.get(r,e);if(t<0)throw new w("Invalid atom header length");return{length:BigInt(t),name:new I(4,"latin1").get(r,e+4)}},put:(r,e,t)=>(i.put(r,e,Number(t.length)),Y.put(r,e+4,t.name))},ce=Q,K={len:4,get:(r,e)=>({type:new I(4,"ascii").get(r,e)})};var f=class{constructor(e,t,a){if(e<t)throw new w(`Atom ${a} expected to be ${t}, but specifies ${e} bytes long.`);e>t&&b(`Warning: atom ${a} expected to be ${t}, but was actually ${e} bytes long.`),this.len=e}},_={len:4,get:(r,e)=>{let t=i.get(r,e)-2082844800;return new Date(t*1e3)}},P=class extends f{constructor(e){super(e,24,"mdhd")}get(e,t){return{version:p.get(e,t+0),flags:u.get(e,t+1),creationTime:_.get(e,t+4),modificationTime:_.get(e,t+8),timeScale:i.get(e,t+12),duration:i.get(e,t+16),language:g.get(e,t+20),quality:g.get(e,t+22)}}},C=class extends f{constructor(e){super(e,100,"mvhd")}get(e,t){return{version:p.get(e,t),flags:u.get(e,t+1),creationTime:_.get(e,t+4),modificationTime:_.get(e,t+8),timeScale:i.get(e,t+12),duration:i.get(e,t+16),preferredRate:i.get(e,t+20),preferredVolume:g.get(e,t+24),previewTime:i.get(e,t+72),previewDuration:i.get(e,t+76),posterTime:i.get(e,t+80),selectionTime:i.get(e,t+84),selectionDuration:i.get(e,t+88),currentTime:i.get(e,t+92),nextTrackID:i.get(e,t+96)}}},D=class{constructor(e){this.len=e}get(e,t){return{type:{set:p.get(e,t+0),type:u.get(e,t+1)},locale:u.get(e,t+4),value:new U(this.len-8).get(e,t+8)}}},v=class{constructor(e){this.len=e}get(e,t){return{version:p.get(e,t),flags:u.get(e,t+1),name:new I(this.len-4,"utf-8").get(e,t+4)}}},$=class{constructor(e){this.len=e}get(e,t){return{version:p.get(e,t),flags:u.get(e,t+1),creationTime:_.get(e,t+4),modificationTime:_.get(e,t+8),trackId:i.get(e,t+12),duration:i.get(e,t+20),layer:g.get(e,t+24),alternateGroup:g.get(e,t+26),volume:g.get(e,t+28)}}},ie={len:8,get:(r,e)=>({version:p.get(r,e),flags:u.get(r,e+1),numberOfEntries:i.get(r,e+4)})},Z=class{constructor(e){this.len=e}get(e,t){let a=this.len-12;return{dataFormat:Y.get(e,t),dataReferenceIndex:g.get(e,t+10),description:a>0?new U(a).get(e,t+12):void 0}}},A=class{constructor(e){this.len=e}get(e,t){let a=ie.get(e,t);t+=ie.len;let n=[];for(let s=0;s<a.numberOfEntries;++s){let o=i.get(e,t);t+=i.len,n.push(new Z(o-i.len).get(e,t)),t+=o}return{header:a,table:n}}},ee={len:8,get(r,e){return{version:B.get(r,e),revision:B.get(r,e+2),vendor:k.get(r,e+4)}}},de={len:12,get(r,e){return{numAudioChannels:B.get(r,e+0),sampleSize:B.get(r,e+2),compressionId:B.get(r,e+4),packetSize:B.get(r,e+6),sampleRate:g.get(r,e+8)+g.get(r,e+10)/1e4}}},x=class{constructor(e,t){this.len=e,this.token=t}get(e,t){let a=k.get(e,t+4);return{version:y.get(e,t+0),flags:q.get(e,t+1),numberOfEntries:a,entries:me(e,this.token,t+8,this.len-8,a)}}},Ne={len:8,get(r,e){return{count:k.get(r,e+0),duration:k.get(r,e+4)}}},F=class extends x{constructor(e){super(e,Ne)}},Ee={len:12,get(r,e){return{firstChunk:k.get(r,e),samplesPerChunk:k.get(r,e+4),sampleDescriptionId:k.get(r,e+8)}}},O=class extends x{constructor(e){super(e,Ee)}},z=class{constructor(e){this.len=e}get(e,t){let a=k.get(e,t+8);return{version:y.get(e,t),flags:q.get(e,t+1),sampleSize:k.get(e,t+4),numberOfEntries:a,entries:me(e,k,t+12,this.len-12,a)}}},L=class extends x{constructor(e){super(e,k),this.len=e}},M=class{constructor(e){this.len=e}get(e,t){let a=B.get(e,t+0);return new I(a,"utf-8").get(e,t+2)}};function me(r,e,t,a,n){if(b(`remainingLen=${a}, numberOfEntries=${n} * token-len=${e.len}`),a===0)return[];if(a!==n*e.len)throw new w("mismatch number-of-entries with remaining atom-length");let s=[];for(let o=0;o<n;++o)s.push(e.get(r,t)),t+=e.len;return s}var R=class{constructor(e){this.len=e}get(e,t){let a=t+1,n={version:y.get(e,t),flags:{baseDataOffsetPresent:T(e,a+2,0),sampleDescriptionIndexPresent:T(e,a+2,1),defaultSampleDurationPresent:T(e,a+2,3),defaultSampleSizePresent:T(e,a+2,4),defaultSampleFlagsPresent:T(e,a+2,5),defaultDurationIsEmpty:T(e,a,0),defaultBaseIsMoof:T(e,a,1)},trackId:i.get(e,4)},s=8;return n.flags.baseDataOffsetPresent&&(n.baseDataOffset=Q.get(e,s),s+=8),n.flags.sampleDescriptionIndexPresent&&(n.sampleDescriptionIndex=i.get(e,s),s+=4),n.flags.defaultSampleDurationPresent&&(n.defaultSampleDuration=i.get(e,s),s+=4),n.flags.defaultSampleSizePresent&&(n.defaultSampleSize=i.get(e,s),s+=4),n.flags.defaultSampleFlagsPresent&&(n.defaultSampleFlags=i.get(e,s)),n}},V=class{constructor(e){this.len=e}get(e,t){let a=t+1,n={version:y.get(e,t),flags:{dataOffsetPresent:T(e,a+2,0),firstSampleFlagsPresent:T(e,a+2,2),sampleDurationPresent:T(e,a+1,0),sampleSizePresent:T(e,a+1,1),sampleFlagsPresent:T(e,a+1,2),sampleCompositionTimeOffsetsPresent:T(e,a+1,3)},sampleCount:i.get(e,t+4),samples:[]},s=t+8;n.flags.dataOffsetPresent&&(n.dataOffset=i.get(e,s),s+=4),n.flags.firstSampleFlagsPresent&&(n.firstSampleFlags=i.get(e,s),s+=4);for(let o=0;o<n.sampleCount;++o){if(s>=this.len){b("TrackRunBox size mismatch");break}let l={};n.flags.sampleDurationPresent&&(l.sampleDuration=i.get(e,s),s+=4),n.flags.sampleSizePresent&&(l.sampleSize=i.get(e,s),s+=4),n.flags.sampleFlagsPresent&&(l.sampleFlags=i.get(e,s),s+=4),n.flags.sampleCompositionTimeOffsetsPresent&&(l.sampleCompositionTimeOffset=i.get(e,s),s+=4),n.samples.push(l)}return n}},W=class{constructor(e){this.len=e}get(e,t){let a=t+1,n=new I(4,"utf-8");return{version:y.get(e,t),flags:u.get(e,t+1),componentType:n.get(e,t+4),handlerType:n.get(e,t+8),componentName:new I(this.len-28,"utf-8").get(e,t+28)}}},H=class{constructor(e){this.len=e}get(e,t){let a=0,n=[];for(;a<this.len;)n.push(i.get(e,t+a)),a+=4;return n}};var Te=(0,pe.default)("music-metadata:parser:MP4:Atom"),j=class r{static readAtom(e,t,a,n){return d(this,null,function*(){let s=e.position;Te(`Reading next token on offset=${s}...`);let o=yield e.readToken(N),l=o.length===1n;l&&(o.length=yield e.readToken(ce));let c=new r(o,l,a),m=c.getPayloadLength(n);return Te(`parse atom name=${c.atomPath}, extended=${c.extended}, offset=${s}, len=${c.header.length}`),yield c.readData(e,t,m),c})}constructor(e,t,a){this.header=e,this.extended=t,this.parent=a,this.children=[],this.atomPath=(this.parent?`${this.parent.atomPath}.`:"")+this.header.name}getHeaderLength(){return this.extended?16:8}getPayloadLength(e){return(this.header.length===0n?e:Number(this.header.length))-this.getHeaderLength()}readAtoms(e,t,a){return d(this,null,function*(){for(;a>0;){let n=yield r.readAtom(e,t,this,a);this.children.push(n),a-=n.header.length===0n?a:Number(n.header.length)}})}readData(e,t,a){return d(this,null,function*(){switch(this.header.name){case"moov":case"udta":case"mdia":case"minf":case"stbl":case"<id>":case"ilst":case"tref":case"moof":return this.readAtoms(e,t,this.getPayloadLength(a));case"meta":{let s=(yield e.peekToken(N)).name==="hdlr"?0:4;return yield e.ignore(s),this.readAtoms(e,t,this.getPayloadLength(a)-s)}default:return t(this,a)}})}};var h=(0,Ie.default)("music-metadata:parser:MP4"),Se="iTunes",ge={raw:{lossy:!1,format:"raw"},MAC3:{lossy:!0,format:"MACE 3:1"},MAC6:{lossy:!0,format:"MACE 6:1"},ima4:{lossy:!0,format:"IMA 4:1"},ulaw:{lossy:!0,format:"uLaw 2:1"},alaw:{lossy:!0,format:"uLaw 2:1"},Qclp:{lossy:!0,format:"QUALCOMM PureVoice"},".mp3":{lossy:!0,format:"MPEG-1 layer 3"},alac:{lossy:!1,format:"ALAC"},"ac-3":{lossy:!0,format:"AC-3"},mp4a:{lossy:!0,format:"MPEG-4/AAC"},mp4s:{lossy:!0,format:"MP4S"},c608:{lossy:!0,format:"CEA-608"},c708:{lossy:!0,format:"CEA-708"}};function ke(r,e,t){return t.indexOf(r)===e}var ue=class r extends re{constructor(){super(...arguments),this.tracks=new Map,this.hasVideoTrack=!1,this.hasAudioTrack=!0,this.atomParsers={mvhd:e=>d(this,null,function*(){let t=yield this.tokenizer.readToken(new C(e));this.metadata.setFormat("creationTime",t.creationTime),this.metadata.setFormat("modificationTime",t.modificationTime)}),chap:e=>d(this,null,function*(){let t=this.getTrackDescription(),a=[];for(;e>=i.len;)a.push(yield this.tokenizer.readNumber(i)),e-=i.len;t.chapterList=a}),mdat:e=>d(this,null,function*(){if(this.audioLengthInBytes=e,this.calculateBitRate(),this.options.includeChapters){let t=[...this.tracks.values()].filter(a=>a.chapterList);if(t.length===1){let a=t[0].chapterList,n=[...this.tracks.values()].filter(s=>a.indexOf(s.header.trackId)!==-1);if(n.length===1)return this.parseChapterTrack(n[0],t[0],e)}}yield this.tokenizer.ignore(e)}),ftyp:e=>d(this,null,function*(){let t=[];for(;e>0;){let n=yield this.tokenizer.readToken(K);e-=K.len;let s=n.type.replace(/\W/g,"");s.length>0&&t.push(s)}h(`ftyp: ${t.join("/")}`);let a=t.filter(ke).join("/");this.metadata.setFormat("container",a)}),stsd:e=>d(this,null,function*(){let t=yield this.tokenizer.readToken(new A(e)),a=this.getTrackDescription();a.soundSampleDescription=t.table.map(n=>this.parseSoundSampleDescription(n))}),stsz:e=>d(this,null,function*(){let t=yield this.tokenizer.readToken(new z(e)),a=this.getTrackDescription();a.sampleSize=t.sampleSize,a.sampleSizeTable=t.entries}),date:e=>d(this,null,function*(){let t=yield this.tokenizer.readToken(new I(e,"utf-8"));yield this.addTag("date",t)})}}static read_BE_Integer(e,t){let a=(t?"INT":"UINT")+e.length*8+(e.length>1?"_BE":""),n=J[a];if(!n)throw new w(`Token for integer type not found: "${a}"`);return Number(n.get(e,0))}parse(){return d(this,null,function*(){this.hasVideoTrack=!1,this.hasAudioTrack=!0,this.tracks.clear();let e=this.tokenizer.fileInfo.size||0;for(;!this.tokenizer.fileInfo.size||e>0;){try{if((yield this.tokenizer.peekToken(N)).name==="\0\0\0\0"){let o=`Error at offset=${this.tokenizer.position}: box.id=0`;h(o),this.addWarning(o);break}}catch(s){if(s instanceof Error){let o=`Error at offset=${this.tokenizer.position}: ${s.message}`;h(o),this.addWarning(o)}else throw s;break}let n=yield j.readAtom(this.tokenizer,(s,o)=>this.handleAtom(s,o),null,e);e-=n.header.length===BigInt(0)?e:Number(n.header.length)}let t=[];this.tracks.forEach(n=>{let s=[];n.soundSampleDescription.forEach(o=>{let l={},c=ge[o.dataFormat];if(c?(s.push(c.format),l.codecName=c.format):l.codecName=`<${o.dataFormat}>`,o.description){let{description:m}=o;m.sampleRate>0&&(l.type=ne.audio,l.audio={samplingFrequency:m.sampleRate,bitDepth:m.sampleSize,channels:m.numAudioChannels})}this.metadata.addStreamInfo(l)}),s.length>=1&&t.push(s.join("/"))}),t.length>0&&this.metadata.setFormat("codec",t.filter(ke).join("+"));let a=[...this.tracks.values()].filter(n=>n.soundSampleDescription.length>=1&&n.soundSampleDescription[0].description&&n.soundSampleDescription[0].description.numAudioChannels>0);if(a.length>=1){let n=a[0];if(n.media.header&&n.media.header.timeScale>0){if(n.media.header.duration>0){h("Using duration defined on audio track");let l=n.media.header.duration/n.media.header.timeScale;this.metadata.setFormat("duration",l)}else if(n.fragments.length>0){h("Calculate duration defined in track fragments");let l=0;for(let c of n.fragments){let m=c.header.defaultSampleDuration;for(let E of c.trackRun.samples){let S=E.sampleDuration??m;if(S==null)throw new Error("Missing sampleDuration and no default_sample_duration in tfhd");l+=S}}this.metadata.setFormat("duration",l/n.media.header.timeScale)}}let s=n.soundSampleDescription[0];if(s.description&&n.media.header&&(this.metadata.setFormat("sampleRate",s.description.sampleRate),this.metadata.setFormat("bitsPerSample",s.description.sampleSize),this.metadata.setFormat("numberOfChannels",s.description.numAudioChannels),n.media.header.timeScale===0&&n.timeToSampleTable.length>0)){let c=n.timeToSampleTable.map(m=>m.count*m.duration).reduce((m,E)=>m+E)/s.description.sampleRate;this.metadata.setFormat("duration",c)}let o=ge[s.dataFormat];o&&this.metadata.setFormat("lossless",!o.lossy),this.calculateBitRate()}this.metadata.setFormat("hasAudio",this.hasAudioTrack),this.metadata.setFormat("hasVideo",this.hasVideoTrack)})}handleAtom(e,t){return d(this,null,function*(){if(e.parent)switch(e.parent.header.name){case"ilst":case"<id>":return this.parseMetadataItemData(e);case"moov":switch(e.header.name){case"trak":return this.parseTrackBox(e)}break;case"moof":switch(e.header.name){case"traf":return this.parseTrackFragmentBox(e)}}if(this.atomParsers[e.header.name])return this.atomParsers[e.header.name](t);h(`No parser for atom path=${e.atomPath}, payload-len=${t}, ignoring atom`),yield this.tokenizer.ignore(t)})}getTrackDescription(){let e=[...this.tracks.values()];return e[e.length-1]}calculateBitRate(){this.audioLengthInBytes&&this.metadata.format.duration&&this.metadata.setFormat("bitrate",8*this.audioLengthInBytes/this.metadata.format.duration)}addTag(e,t){return d(this,null,function*(){yield this.metadata.addTag(Se,e,t)})}addWarning(e){h(`Warning: ${e}`),this.metadata.addWarning(e)}parseMetadataItemData(e){let t=e.header.name;return e.readAtoms(this.tokenizer,(a,n)=>d(this,null,function*(){let s=a.getPayloadLength(n);switch(a.header.name){case"data":return this.parseValueAtom(t,a);case"name":case"mean":case"rate":{let o=yield this.tokenizer.readToken(new v(s));t+=`:${o.name}`;break}default:{let o=yield this.tokenizer.readToken(new U(s));this.addWarning(`Unsupported meta-item: ${t}[${a.header.name}] => value=${ae(o)} ascii=${te(o,"ascii")}`)}}}),e.getPayloadLength(0))}parseValueAtom(e,t){return d(this,null,function*(){let a=yield this.tokenizer.readToken(new D(Number(t.header.length)-N.len));if(a.type.set!==0)throw new w(`Unsupported type-set != 0: ${a.type.set}`);switch(a.type.type){case 0:switch(e){case"trkn":case"disk":{let n=p.get(a.value,3),s=p.get(a.value,5);yield this.addTag(e,`${n}/${s}`);break}case"gnre":{let n=p.get(a.value,1),s=oe[n-1];yield this.addTag(e,s);break}case"rate":{let n=new TextDecoder("ascii").decode(a.value);yield this.addTag(e,n);break}default:h(`unknown proprietary value type for: ${t.atomPath}`)}break;case 1:case 18:yield this.addTag(e,new TextDecoder("utf-8").decode(a.value));break;case 13:if(this.options.skipCovers)break;yield this.addTag(e,{format:"image/jpeg",data:Uint8Array.from(a.value)});break;case 14:if(this.options.skipCovers)break;yield this.addTag(e,{format:"image/png",data:Uint8Array.from(a.value)});break;case 21:yield this.addTag(e,r.read_BE_Integer(a.value,!0));break;case 22:yield this.addTag(e,r.read_BE_Integer(a.value,!1));break;case 65:yield this.addTag(e,p.get(a.value,0));break;case 66:yield this.addTag(e,g.get(a.value,0));break;case 67:yield this.addTag(e,i.get(a.value,0));break;default:this.addWarning(`atom key=${e}, has unknown well-known-type (data-type): ${a.type.type}`)}})}parseTrackBox(e){return d(this,null,function*(){let t={media:{},fragments:[]};yield e.readAtoms(this.tokenizer,(a,n)=>d(this,null,function*(){let s=a.getPayloadLength(n);switch(a.header.name){case"chap":{let o=yield this.tokenizer.readToken(new H(n));t.chapterList=o;break}case"tkhd":t.header=yield this.tokenizer.readToken(new $(s));break;case"hdlr":switch(t.handler=yield this.tokenizer.readToken(new W(s)),t.handler.handlerType){case"audi":h("Contains audio track"),this.hasAudioTrack=!0;break;case"vide":h("Contains video track"),this.hasVideoTrack=!0;break}break;case"mdhd":{let o=yield this.tokenizer.readToken(new P(s));t.media.header=o;break}case"stco":{let o=yield this.tokenizer.readToken(new L(s));t.chunkOffsetTable=o.entries;break}case"stsc":{let o=yield this.tokenizer.readToken(new O(s));t.sampleToChunkTable=o.entries;break}case"stsd":{let o=yield this.tokenizer.readToken(new A(s));t.soundSampleDescription=o.table.map(l=>this.parseSoundSampleDescription(l));break}case"stts":{let o=yield this.tokenizer.readToken(new F(s));t.timeToSampleTable=o.entries;break}case"stsz":{let o=yield this.tokenizer.readToken(new z(s));t.sampleSize=o.sampleSize,t.sampleSizeTable=o.entries;break}case"dinf":case"vmhd":case"smhd":h(`Ignoring: ${a.header.name}`),yield this.tokenizer.ignore(s);break;default:h(`Unexpected track box: ${a.header.name}`),yield this.tokenizer.ignore(s)}}),e.getPayloadLength(0)),this.tracks.set(t.header.trackId,t)})}parseTrackFragmentBox(e){let t;return e.readAtoms(this.tokenizer,(a,n)=>d(this,null,function*(){let s=a.getPayloadLength(n);switch(a.header.name){case"tfhd":{let o=new R(a.getPayloadLength(n));t=yield this.tokenizer.readToken(o);break}case"tfdt":yield this.tokenizer.ignore(s);break;case"trun":{let o=new V(s),l=yield this.tokenizer.readToken(o);t&&this.tracks.get(t.trackId)?.fragments.push({header:t,trackRun:l});break}default:h(`Unexpected box: ${a.header.name}`),yield this.tokenizer.ignore(s)}}),e.getPayloadLength(0))}parseSoundSampleDescription(e){let t={dataFormat:e.dataFormat,dataReferenceIndex:e.dataReferenceIndex},a=0;if(e.description){let n=ee.get(e.description,a);a+=ee.len,n.version===0||n.version===1?t.description=de.get(e.description,a):h(`Warning: sound-sample-description ${n} not implemented`)}return t}parseChapterTrack(e,t,a){return d(this,null,function*(){if(!e.sampleSize&&e.chunkOffsetTable.length!==e.sampleSizeTable.length)throw new Error("Expected equal chunk-offset-table & sample-size-table length.");let n=[];for(let s=0;s<e.chunkOffsetTable.length&&a>0;++s){let o=e.timeToSampleTable.slice(0,s).reduce((we,Be)=>we+Be.duration,0),c=e.chunkOffsetTable[s]-this.tokenizer.position,m=e.sampleSize>0?e.sampleSize:e.sampleSizeTable[s];if(a-=c+m,a<0)throw new w("Chapter chunk exceeding token length");yield this.tokenizer.ignore(c);let E=yield this.tokenizer.readToken(new M(m));h(`Chapter ${s+1}: ${E}`);let S={title:E,timeScale:e.media.header?e.media.header.timeScale:0,start:o,sampleOffset:this.findSampleOffset(t,this.tokenizer.position)};h(`Chapter title=${S.title}, offset=${S.sampleOffset}/${t.header.duration}`),n.push(S)}this.metadata.setFormat("chapters",n),yield this.tokenizer.ignore(a)})}findSampleOffset(e,t){let a=0;for(;a<e.chunkOffsetTable.length&&e.chunkOffsetTable[a]<t;)++a;return this.getChunkDuration(a+1,e)}getChunkDuration(e,t){let a=0,n=t.timeToSampleTable[a].count,s=t.timeToSampleTable[a].duration,o=1,l=this.getSamplesPerChunk(o,t.sampleToChunkTable),c=0;for(;o<e;){let m=Math.min(n,l);c+=m*s,n-=m,l-=m,l===0?(++o,l=this.getSamplesPerChunk(o,t.sampleToChunkTable)):(++a,n=t.timeToSampleTable[a].count,s=t.timeToSampleTable[a].duration)}return c}getSamplesPerChunk(e,t){for(let a=0;a<t.length-1;++a)if(e>=t[a].firstChunk&&e<t[a+1].firstChunk)return t[a].samplesPerChunk;return t[t.length-1].samplesPerChunk}};export{ue as MP4Parser};
